<?php
/**
 * Copyright (c) Andreas Heigl<andreas@heigl.org>
 *
 * Permission is hereby granted, free of charge, to any person obtaining a copy
 * of this software and associated documentation files (the "Software"), to deal
 * in the Software without restriction, including without limitation the rights
 * to use, copy, modify, merge, publish, distribute, sublicense, and/or sell
 * copies of the Software, and to permit persons to whom the Software is
 * furnished to do so, subject to the following conditions:
 *
 * The above copyright notice and this permission notice shall be included in
 * all copies or substantial portions of the Software.
 *
 * THE SOFTWARE IS PROVIDED "AS IS", WITHOUT WARRANTY OF ANY KIND, EXPRESS OR
 * IMPLIED, INCLUDING BUT NOT LIMITED TO THE WARRANTIES OF MERCHANTABILITY,
 * FITNESS FOR A PARTICULAR PURPOSE AND NONINFRINGEMENT. IN NO EVENT SHALL THE
 * AUTHORS OR COPYRIGHT HOLDERS BE LIABLE FOR ANY CLAIM, DAMAGES OR OTHER
 * LIABILITY, WHETHER IN AN ACTION OF CONTRACT, TORT OR OTHERWISE, ARISING FROM,
 * OUT OF OR IN CONNECTION WITH THE SOFTWARE OR THE USE OR OTHER DEALINGS IN
 * THE SOFTWARE.
 *
 * @author    Andreas Heigl<andreas@heigl.org>
 * @copyright Andreas Heigl
 * @license   http://www.opensource.org/licenses/mit-license.php MIT-License
 * @since     30.11.2017
 * @link      http://github.com/heiglandreas/org.heigl.PdfTextRetriever
 */

namespace Org_Heigl\PdfTextRetrieverTest;

use Org_Heigl\PdfTextRetriever\FontWidthMap;
use Org_Heigl\PdfTextRetriever\StreamParser;
use Org_Heigl\PdfTextRetriever\TextContent;
use PHPUnit\Framework\TestCase;
use Mockery as M;

class StreamParserTest extends TestCase
{

    public function testParseEmptyString()
    {
        $parser = new StreamParser();
        $this->assertEquals(new TextContent(), $parser->parse('', new FontWidthMap()));
    }

    public function testParseTextString()
    {
        $fontMap = M::mock(FontWidthMap::class);
        $fontMap->shouldReceive('getCharWidth')->andReturn(500);

        $stream = 'q Q q 0 0 720 450 re W n /Perceptual ri q 720 0 0 450 0 0 cm /Im1 Do Q Q q
625 40 m 625 40 l 625 23.80253 l 667.1988 23.80253 l 667.1988 40 l W* n 625 24 42 16
re W n /Cs1 cs 0.9960784 0.9960784 0.9960784 sc 653.0767 26.51143 m 653.0767
26.51143 l 653.0767 26.2092 653.0321 26.0189 652.9316 25.90697 c 652.753 25.70548
652.1613 25.42563 651.6478 25.42563 c 650.096 25.42563 648.9238 26.91441 648.9238
29.15318 c 648.9238 30.98897 649.8616 32.45536 651.3352 32.45536 c 652.0162
32.45536 652.4962 32.13074 652.7976 31.71656 c 653.0097 31.40314 653.0767
31.1009 653.0767 30.66434 c 653.0767 26.51143 l h 655.3653 36.68662 m 655.3653
36.68662 l 655.3653 37.62691 655.3876 38.98136 655.4323 39.85448 c 655.3876
39.96642 655.2536 40.03358 655.1197 40.01119 c 654.2489 39.67538 653.1214
39.21644 652.2729 38.98136 c 652.1166 38.9142 652.139 38.56719 652.2729 38.47764
c 652.5743 38.27615 l 653.0544 37.9963 653.0767 37.83959 653.0767 36.38439
c 653.0767 33.51877 l 653.0767 33.2837 653.0321 33.19415 652.9428 33.17176
c 652.6637 33.26131 652.2506 33.32848 651.6813 33.32848 c 648.9685 33.32848
646.4566 31.44791 646.4566 28.30245 c 646.4566 26.11965 648.0084 24.11595
650.4867 24.11595 c 651.5361 24.11595 652.3399 24.61968 652.9874 25.10101
c 653.099 25.07862 l 653.1437 24.96668 653.1437 24.78758 653.1214 24.46296
c 653.0767 24.13834 l 653.1214 24.00402 653.233 23.91446 653.3447 23.89208
c 654.1261 24.25028 655.6667 24.61968 656.7831 24.73161 c 657.0175 24.85475
656.9729 25.38086 656.8054 25.51518 c 656.4705 25.38086 656.1244 25.31369
655.89 25.31369 c 655.5216 25.31369 655.3653 25.99652 655.3653 27.97783 c
655.3653 36.68662 l h 655.3653 36.68662 m f* 625 33.07102 m 625 33.07102 l
627.9695 33.07102 l 627.9695 30.09346 l 625 30.09346 l 625 33.07102 l h 625
33.07102 m f 641.4106 32.45536 m 641.4106 32.45536 l 641.6116 32.5673 641.5893
33.00386 641.3772 33.08221 c 640.6515 33.03744 639.7584 33.02624 639.0216
33.02624 c 638.2848 33.02624 637.481 33.03744 636.9117 33.08221 c 636.6884
33.00386 636.6661 32.58968 636.8447 32.45536 c 637.2578 32.34342 l 637.7601
32.23148 638.0169 32.15312 638.2178 31.67179 c 638.2625 31.35836 638.2625
31.14568 637.9946 30.50763 c 637.3917 29.07482 l 637.1684 28.5711 636.8224
27.76514 636.6103 27.32858 c 636.4316 27.74276 635.9293 28.87333 635.5162
29.92555 c 634.9469 31.33597 l 634.8017 31.71656 634.7124 31.90686 634.7124
32.04119 c 634.7124 32.18671 634.9022 32.25387 635.2371 32.34342 c 635.6055
32.45536 l 635.7507 32.5673 635.7395 33.00386 635.5609 33.08221 c 634.9692
33.03744 634.2324 33.02624 633.4063 33.02624 c 632.5578 33.02624 631.8768
33.03744 631.0954 33.08221 c 630.9279 33.00386 630.8833 32.62326 631.0284
32.45536 c 631.408 32.36581 l 632.0108 32.20909 632.1894 32.04119 632.4015
31.58224 c 633.317 29.56735 634.0091 27.8435 634.4445 26.89202 c 634.9022
25.88458 635.3599 24.73161 635.5385 24.25028 c 635.6502 24.16073 635.773 24.11595
635.9293 24.11595 c 636.0856 24.11595 636.2084 24.16073 636.2977 24.25028
c 636.7107 25.47041 638.2178 28.78378 638.8653 30.18301 c 639.524 28.73901
640.6738 26.16442 641.4553 24.25028 c 641.5669 24.16073 641.7009 24.11595
641.846 24.11595 c 642.0023 24.11595 642.1363 24.16073 642.2256 24.25028 c
642.661 25.42563 643.2192 26.84725 643.6992 27.95544 c 645.0277 30.98897 l
645.4854 32.06357 645.6863 32.18671 646.2445 32.34342 c 646.6576 32.45536
l 646.8139 32.62326 646.7916 33.00386 646.5906 33.08221 c 645.8985 33.03744
645.3738 33.02624 644.8714 33.02624 c 644.3802 33.02624 643.8332 33.03744
643.0964 33.08221 c 642.9178 33.00386 642.8731 32.58968 643.0517 32.45536
c 643.7885 32.29864 l 644.0453 32.23148 644.2016 32.15312 644.2016 32.0188
c 644.2016 31.86209 644.1346 31.60463 643.9671 31.1009 c 643.6545 30.25017
642.8061 28.06738 642.4377 27.32858 c 642.0247 28.25767 640.9976 30.48524
640.6069 31.55985 c 640.5064 31.8397 640.4841 31.97402 640.4841 32.08596 c
640.4841 32.20909 640.6515 32.27626 641.0199 32.36581 c 641.4106 32.45536
l h 641.4106 32.45536 m f 625 27.1159 m 625 27.1159 l 627.9695 27.1159 l 627.9695
24.13834 l 625 24.13834 l 625 27.1159 l h 625 27.1159 m f 664.9996 30.59718
m 664.9996 30.59718 l 665.6805 32.08596 665.982 32.23148 666.6406 32.36581
c 667.076 32.45536 l 667.2435 32.60088 667.2211 33.00386 667.0314 33.08221
c 666.5513 33.03744 666.0043 33.02624 665.4349 33.02624 c 664.8098 33.02624
664.2628 33.03744 663.6153 33.08221 c 663.3697 33.00386 663.3473 32.62326
663.5259 32.45536 c 664.0506 32.34342 l 664.3074 32.29864 664.5084 32.20909
664.5084 32.06357 c 664.5084 31.90686 664.419 31.62701 664.1958 31.07852 c
663.6376 29.70168 663.1129 28.36961 662.5882 27.28381 c 662.2644 27.93305
661.1481 30.64196 660.8467 31.44791 c 660.7127 31.77253 660.668 32.0188 660.668
32.15312 c 660.668 32.27626 660.9136 32.32103 661.2151 32.38819 c 661.6058
32.45536 l 661.8067 32.60088 661.7844 33.00386 661.5611 33.08221 c 660.802
33.03744 660.1545 33.02624 659.1721 33.02624 c 658.413 33.02624 657.6427 33.03744
656.8835 33.08221 c 656.7161 32.98147 656.6938 32.60088 656.8389 32.45536
c 657.2519 32.36581 l 657.9106 32.20909 658.145 31.95164 658.5804 31.01135
c 658.9935 30.09346 660.1992 27.35097 660.668 26.27636 c 660.936 25.70548
661.282 24.85475 661.5053 24.25028 c 661.6058 24.16073 661.7398 24.11595 661.8961
24.11595 c 662.0412 24.11595 662.1751 24.16073 662.2644 24.25028 c 662.5212
24.98907 662.9343 26.0189 663.2803 26.80247 c 664.9996 30.59718 l h 664.9996
30.59718 m f Q q 0 0 720 450 re W n 1 j 4 M /Cs1 CS 1 1 1 SC q 1 -0.0006151967 -0.0006151967 -1 55.99999 42.9437
cm 0 0 m 609.6252 0 l S Q /Cs1 cs 1 1 1 sc q 1 0 0 1 85 335 cm BT -0.0214
Tc 62 0 0 62 0 0 Tm /TT1 1 Tf [ (Th) 27 (e) 27 (m) 27 (e) 27 (n) 27 (t) 27
(o) 27 (u) 27 (r) 27 ( ) 27 (2) 27 (0) 27 (1) 27 (7) ] TJ ET Q q 1 0 0 1 85 335
cm BT 62 0 0 62 552.6885 0 Tm /TT3 1 Tf (!) Tj ET Q q 1 0 0 1 208 294 cm BT
-0.073 Tc 20 0 0 20 0 0 Tm /TT1 1 Tf [ (Th) 27 (e) 27 (m) 27 (e) 27 (n) 27
( ) 27 (g) 27 (e) 27 (m) 27 (e) 27 (i) 27 (n) 27 (s) 27 (a) 27 (m) 27 ( )
27 (e) 27 (n) 27 (t) 27 (w) 27 (i) 27 (c) 44 (k) 61 (e) 27 (l) 27 (n) 27 ( )
27 (�) ] TJ ET Q q 1 0 0 1 208 294 cm BT 20 0 0 20 306.0137 0 Tm /TT3 1 Tf
(!) Tj ET Q q 1 0 0 1 272 266 cm BT -0.1259 Tc 20 0 0 20 0 0 Tm /TT1 1 Tf
[ (Ku) -26 (n) -26 (d) -26 (e) -26 (n) -26 ( ) -26 (b) -26 (e) -51 (g) -26
(e) -26 (i) -26 (s) -26 (t) -26 (e) -26 (r) -76 (n) -26 (!) ] TJ ET Q q 1 0 0 1 55 89
cm BT -0.1134 Tc 16 0 0 16 0 0 Tm /TT1 1 Tf [ (Vo) -51 (r) -68 (a) -51 (u)
-51 (s) -25 (w) -40 (a) -51 (h) -51 (l) -51 ( ) -51 (f) -51 (�) -51 (r) -51
( ) -51 (A) -33 (O) -51 (K) -51 ( ) -51 (P) -51 (L) -25 (U) -51 (S) -51 ( )
-51 (F) -25 (a) -51 (c) -34 (h) -51 (b) -51 (e) -51 (r) -67 (e) -51 (i) -51
(c) -34 (h) -51 (e) -51 ( ) ] TJ ET Q q 1 0 0 1 55 89 cm BT 16 0 0 16 319.6094 0
Tm /TT3 1 Tf (!) Tj ET Q q 1 0 0 1 55 66 cm BT -0.0623 Tc 16 0 0 16 0 0 Tm
/TT1 1 Tf [ (Pr) -17 (�) 17 (v) 26 (ention | Mar) -33 (k) 34 (eting) ] TJ
/TT4 1 Tf (!) Tj /TT1 1 Tf [ (| Ev) 26 (ent | V) 51 (er) -50 (trie) 10 (b | Pfle)
-25 (ge) ] TJ ET Q Q';
        $parser = new StreamParser();
        $this->assertEquals([[], []], $parser->parse($stream, $fontMap)->content);
    }
}
